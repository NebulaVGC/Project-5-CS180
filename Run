import javax.swing.*;
import java.io.*;
import java.net.Socket;
import java.util.ArrayList;
import java.util.Scanner;

/**
 * Project 04 -- Run
 * <p>
 * This class prompts user to sign in as teacher or student
 *
 * @author Tim Chou L09
 * @version April 11, 2022
 */

public class Run {
    //Initiates string prompts
    final static String WELCOMEPROMPT = "\nPlease choose a login type";
    final static String ERROR = "There was an error!";
    final static String ACCOUNTPROMPT = "How would you like to proceed?\n1. Make a new account" +
            "\n2. Login with existing account\n3. Edit existing account";
    final static String MAKEUSERNAME = "Please enter your desired username";
    final static String MAKEPASSWORD = "Please enter your desired password";
    final static String USERNAMEERROR = "Username can not contain space!";
    final static String PASSWORDERROR = "Password can not contain space!";
    final static String LOGINUSERNAME = "Please enter your username";
    final static String LOGINPASSWORD = "Please enter your password";
    final static String EDITACCOUNT = "What would you like to edit?\n1. Account name\n2. Password";
    final static String WRONGPASSWORD = "That's the wrong password!";
    final static String USERNAMEEXIST = "This username already existed!";
    final static String USERNAMEDOESNOTEXIST = "This username does not exist" + "!";

    public static Object obj = new Object();

    /*
    method that runs the quiz and takes the scanner as a parameter
     */
    public static String runQuiz(Socket socket) {

        try {
            BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            PrintWriter writer = new PrintWriter(socket.getOutputStream());

            int usernameStatus;
            int welcome = 0;
            int account;
            int[] loginType = new int[1];
            int[] accountChoice = new int[1];
            int[] login = new int[1];

            ArrayList<String> teacherAccountStore = new ArrayList<>();
            ArrayList<String> teacherPasswordStore = new ArrayList<>();
            ArrayList<String> studentAccountStore = new ArrayList<>();
            ArrayList<String> studentPasswordStore = new ArrayList<>();

            String username1; //initiates username of current user
            int welcomeChoice = 0;
            while (welcome == 0) {
                welcomeChoice = showWelcomeMessageDialog();
                try {
                    if (welcomeChoice == 10) {
                        return "";
                    } else {
                        welcome++; //breaks out of loop
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }

            if (welcomeChoice == 1) {
                while (login[0] == 0) {
                    account = 0;
                    usernameStatus = 0;
                    int proceed = 0;
                    synchronized (obj) {
                        while (account == 0) {
                            proceed = accountPrompt();
                            try {
                                if (proceed != 1 && proceed != 2 && proceed != 3) {
                                    //throws error if account choice is invalid option
                                    return "";
                                } else {
                                    account++; //breaks out of loop
                                }
                            } catch (Exception e) {
                                e.printStackTrace();
                            }
                        }
                    }

                    synchronized (obj) {

                        int teacherAccountCount = Integer.parseInt(reader.readLine());
                        for (int i = 0; i < teacherAccountCount; i++) {
                            teacherAccountStore.add(reader.readLine());
                        }
                        int teacherPasswordCount = Integer.parseInt(reader.readLine());
                        for (int i = 0; i < teacherPasswordCount; i++) {
                            teacherPasswordStore.add(reader.readLine());
                        }
                        int studentAccountCount = Integer.parseInt(reader.readLine());
                        for (int i = 0; i < studentAccountCount; i++) {
                            studentAccountStore.add(reader.readLine());
                        }
                        int studentPasswordCount = Integer.parseInt(reader.readLine());
                        for (int i = 0; i < studentPasswordCount; i++) {
                            studentPasswordStore.add(reader.readLine());
                        }
                    }

                    if (proceed == 1) {
                        synchronized (obj) {
                            writer.write("create");
                            writer.println();
                            writer.flush();
                            writer.write("teacher");
                            writer.println();
                            writer.flush();
                        }
                    } else if (proceed == 2) { //if user wants to login to existing account
                        synchronized (obj) {

                            while (usernameStatus == 0) {
                                try {
                                    String userName = "checkTeacherNameExist()";
                                    String password = "checkTeacherPasswordExist()";

                                    ArrayList<String> accountList = new ArrayList<>();
                                    ArrayList<String> passwordList = new ArrayList<>();

                                    File f = new File("TeacherAccount.txt");
                                    FileReader fr = new FileReader(f);
                                    BufferedReader bfr = new BufferedReader(fr);
                                    String line = bfr.readLine();
                                    usernameStatus = 1;
                                    while (line != null) {
                                        accountList.add(line);
                                        line = bfr.readLine();
                                    }
                                    bfr.close();

                                    File f2 = new File("TeacherPassword.txt");
                                    FileReader fr2 = new FileReader(f2);
                                    BufferedReader bfr2 = new BufferedReader(fr2);
                                    String line2 = bfr2.readLine();

                                    while (line2 != null) {
                                        passwordList.add(line2);
                                        line2 = bfr2.readLine();
                                    }
                                    bfr2.close();

                                    if (passwordList.get(accountList.indexOf(userName)).equals(password)) {
                                        writer.write("login");
                                        writer.println();
                                        writer.flush();
                                        writer.write("teacher");
                                        writer.println();
                                        writer.flush();
                                        return "Teacher " + userName;
                                    } else {
                                        informationMismatch();
                                        break;
                                    }

                                } catch (Exception e) {
                                    e.printStackTrace();
                                }
                            }
                        }
                    } else if (proceed == 3) { //if teacher wants to edit account
                        synchronized (obj) {
                            writer.write("edit");
                            writer.println();
                            writer.flush();
                            writer.write("teacher");
                            writer.println();
                            writer.flush();

                        }
                    }
                }
                writer.close();
                reader.close();
            } else if (welcomeChoice == 2) { //student login
                while (login[0] == 0) {

                    account = 0;
                    usernameStatus = 0;
                    int proceed = 0;
                    while (account == 0) {
                        proceed = accountPrompt();
                        try {
                            if (proceed != 1 && proceed != 2 && proceed != 3) {
                                //throws error if account choice is invalid option
                                return "";
                            } else {
                                account++; //breaks out of loop
                            }
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                    if (proceed == 1) {
                        synchronized (obj) {
                            writer.write("create");
                            writer.println();
                            writer.flush();
                            writer.write("teacher");
                            writer.println();
                            writer.flush();
                        }
                    } else if (proceed == 2) { //create account depending on whether student or teacher
                        synchronized (obj) {
                            while (usernameStatus == 0) {
                                try {
                                    String username = "hi";
                                    String password = "checkStudentPasswordExist()";

                                    ArrayList<String> accountList = new ArrayList<>();
                                    ArrayList<String> passwordList = new ArrayList<>();

                                    File f = new File("StudentAccount.txt");
                                    FileReader fr = new FileReader(f);
                                    BufferedReader bfr = new BufferedReader(fr);
                                    String line = bfr.readLine();
                                    usernameStatus = 1;
                                    while (line != null) {
                                        accountList.add(line);
                                        line = bfr.readLine();
                                    }
                                    bfr.close();

                                    File f2 = new File("StudentPassword.txt");
                                    FileReader fr2 = new FileReader(f2);
                                    BufferedReader bfr2 = new BufferedReader(fr2);
                                    String line2 = bfr2.readLine();

                                    while (line2 != null) {
                                        passwordList.add(line2);
                                        line2 = bfr2.readLine();
                                    }
                                    bfr2.close();

                                    if (passwordList.get(accountList.indexOf(username)).equals(password)) {
                                        writer.write("login");
                                        writer.println();
                                        writer.flush();
                                        writer.write("student");
                                        writer.println();
                                        writer.flush();
                                        return "Student" + username;
                                    } else {
                                        informationMismatch();
                                        break;
                                    }

                                } catch (Exception e) {
                                    e.printStackTrace();
                                }
                            }
                        }
                    } else if (proceed == 3) { //if teacher wants to edit account
                        synchronized (obj) {
                            writer.write("edit");
                            writer.println();
                            writer.flush();
                            writer.write("teacher");
                            writer.println();
                            writer.flush();

                        }
                    }
                }
            }


        } catch (
                Exception e) {
            e.printStackTrace();
        }

        return "";
    }

    /*
    method that checks the teacher and student account/passwords
     */


    public static int showWelcomeMessageDialog() {

        String[] options = {"Teacher", "Student"};
        int result = 1;
        do {
            result = JOptionPane.showOptionDialog(null, "Welcome!" + WELCOMEPROMPT, "User Type",
                    JOptionPane.YES_NO_OPTION, JOptionPane.INFORMATION_MESSAGE,
                    null, options, null);
            if (result == JOptionPane.CLOSED_OPTION) {
                return 10;
            } else if (result == JOptionPane.YES_OPTION) {
                return 1;
            } else if (result == JOptionPane.NO_OPTION) {
                return 2;
            }
        } while (result != 0);

        return result;

    }

    public static int accountPrompt() {

        String[] options = {"1. Make a new account", "2. Login with existing account", "3. Edit existing account"};
        String result = "";
        do {
            result = (String) JOptionPane.showInputDialog(null, "How would you like to proceed?", "Action selection",
                    JOptionPane.QUESTION_MESSAGE, null, options, options[0]);
            if (result == null) {
                return 4;
            }
            if (result.equals("1. Make a new account")) {
                return 1;
            } else if (result.equals("2. Login with existing account")) {
                return 2;
            } else if (result.equals("3. Edit existing account")) {
                return 3;
            } else {
                return 4;
            }
        } while (result.equals("true"));
    }

    public static void informationMismatch() {
        JOptionPane.showMessageDialog(null, "Your information did not match with our record", "Button Game",
                JOptionPane.ERROR_MESSAGE);
    }


}
